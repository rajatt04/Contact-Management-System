<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contact Management System</title>

  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    /* Global */
    body {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding-top: 4.5rem;
      font-family: "Segoe UI", sans-serif;
    }

    /* Navbar */
    .navbar {
      background: linear-gradient(90deg, #0d6efd, #6610f2);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .navbar-brand {
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    /* Card styling */
    .card {
      border: none;
      border-radius: 1rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.1);
    }

    /* Input focus glow */
    input:focus, textarea:focus {
      box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25) !important;
    }

    /* Contact list */
    #contactsList .list-group-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: none;
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
      padding: 1rem;
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      transition: transform 0.15s ease;
    }
    #contactsList .list-group-item:hover {
      transform: scale(1.01);
      background: #f8f9fa;
    }

    /* Buttons */
    .btn-gradient {
      background: linear-gradient(90deg, #0d6efd, #6610f2);
      color: #fff;
      border: none;
    }
    .btn-gradient:hover {
      background: linear-gradient(90deg, #0b5ed7, #520dc2);
      color: #fff;
    }

    /* Stats card */
    .stats-value {
      font-size: 2rem;
      font-weight: bold;
      color: #0d6efd;
    }

    /* Search card icon */
    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #adb5bd;
    }
    .search-wrapper {
      position: relative;
    }
    .search-wrapper input {
      padding-left: 2.5rem;
    }

    /* Offcanvas styling */
    .offcanvas {
      border-top-left-radius: 1rem;
      border-bottom-left-radius: 1rem;
    }

    /* Modal */
    .modal-content {
      border-radius: 1rem;
    }

    /* Subtle fade animations */
    .fade-in {
      animation: fadeIn 0.4s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><i class="bi bi-person-lines-fill me-2"></i>Contact Manager</a>
    <div class="d-flex">
      <button id="downloadCsvBtn" class="btn btn-outline-light me-2"><i class="bi bi-download me-1"></i>CSV</button>
      <button class="btn btn-light" data-bs-toggle="offcanvas" data-bs-target="#addPanel"><i class="bi bi-plus-circle me-1"></i>Add</button>
    </div>
  </div>
</nav>

<div class="container fade-in">
  <div class="row g-4">
    <!-- Left Column -->
    <div class="col-lg-4">
      <!-- Search -->
      <div class="card p-3">
        <h5 class="card-title mb-3"><i class="bi bi-search me-1"></i>Search</h5>
        <div class="search-wrapper">
          <i class="bi bi-search search-icon"></i>
          <input id="searchInput" type="search" class="form-control" placeholder="Search by name, phone, email..." />
        </div>
        <div class="small-muted mt-2">Live results appear as you type.</div>
      </div>

      <!-- Stats -->
      <div class="card p-3 mt-3 text-center">
        <h6 class="mb-2 text-muted"><i class="bi bi-bar-chart-fill me-1"></i>Statistics</h6>
        <div class="stats-value" id="totalCount">0</div>
        <div class="text-muted">Total Contacts</div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-8">
      <div class="card p-3">
        <h5 class="card-title mb-3"><i class="bi bi-people-fill me-1"></i>All Contacts</h5>
        <ul id="contactsList" class="list-group list-group-flush"></ul>
        <div id="emptyHint" class="text-muted mt-3 text-center py-3 border rounded">No contacts found. Use "Add Contact" to create one.</div>
      </div>
    </div>
  </div>
</div>

<!-- Add Contact Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="addPanel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title"><i class="bi bi-person-plus-fill me-1"></i>Add Contact</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <form id="addForm">
      <div class="mb-3">
        <label class="form-label">Name *</label>
        <input id="add-name" class="form-control" required />
      </div>
      <div class="mb-3">
        <label class="form-label">Phone</label>
        <input id="add-phone" class="form-control" />
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input id="add-email" class="form-control" type="email" />
      </div>
      <div class="mb-3">
        <label class="form-label">Address</label>
        <input id="add-address" class="form-control" />
      </div>
      <div class="mb-3">
        <label class="form-label">Tags (comma separated)</label>
        <input id="add-tags" class="form-control" />
      </div>
      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-gradient"><i class="bi bi-check-lg me-1"></i>Add</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square me-1"></i>Edit Contact</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-id" />
        <div class="mb-3"><label class="form-label">Name *</label><input id="edit-name" class="form-control" required/></div>
        <div class="mb-3"><label class="form-label">Phone</label><input id="edit-phone" class="form-control"/></div>
        <div class="mb-3"><label class="form-label">Email</label><input id="edit-email" class="form-control" type="email"/></div>
        <div class="mb-3"><label class="form-label">Address</label><input id="edit-address" class="form-control"/></div>
        <div class="mb-3"><label class="form-label">Tags (comma separated)</label><input id="edit-tags" class="form-control"/></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Cancel</button>
        <button type="submit" class="btn btn-gradient"><i class="bi bi-save me-1"></i>Save changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const API_BASE = "/api/contacts";
  const searchInput = document.getElementById("searchInput");
  const contactsList = document.getElementById("contactsList");
  const totalCount = document.getElementById("totalCount");
  const emptyHint = document.getElementById("emptyHint");

  // bootstrap components
  const editModalEl = document.getElementById('editModal');
  const editModal = new bootstrap.Modal(editModalEl);

  // load all contacts
  async function loadAll() {
    const res = await fetch(API_BASE);
    const data = await res.json();
    renderList(data);
  }

  // search (live)
  let searchTimer = null;
  searchInput.addEventListener("input", () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(async () => {
      const q = searchInput.value.trim();
      if (!q) { loadAll(); return; }
      const res = await fetch(`${API_BASE}/search?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      renderList(data);
    }, 250);
  });

  function renderList(items) {
    contactsList.innerHTML = "";
    totalCount.textContent = items.length;
    if (!items.length) {
      emptyHint.style.display = "block";
      return;
    } else {
      emptyHint.style.display = "none";
    }

    items.forEach(c => {
      const li = document.createElement("li");
      li.className = "list-group-item";
      li.innerHTML = `
        <div>
          <strong>${escapeHtml(c.name)}</strong>
          <div class="small-muted">${escapeHtml(c.phone)} ${c.email ? "- " + escapeHtml(c.email) : ""}</div>
          ${c.address ? `<div class="small-muted">${escapeHtml(c.address)}</div>` : ""}
          ${c.tags && c.tags.length ? `<div class="small-muted">Tags: ${escapeHtml(c.tags.join(", "))}</div>` : ""}
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary me-2" onclick="openEdit('${c._id}')">Edit</button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeContact('${c._id}')">Delete</button>
        </div>
      `;
      contactsList.appendChild(li);
    });
  }

  // escape simple HTML
  function escapeHtml(s) {
    if (!s) return "";
    return s.replaceAll("&", "&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  // add contact
  document.getElementById("addForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("add-name").value.trim();
    if (!name) return alert("Name required");
    const contact = {
      name,
      phone: document.getElementById("add-phone").value.trim(),
      email: document.getElementById("add-email").value.trim(),
      address: document.getElementById("add-address").value.trim(),
      tags: document.getElementById("add-tags").value.split(",").map(t=>t.trim()).filter(Boolean)
    };
    await fetch(API_BASE, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(contact) });
    // close offcanvas
    const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('addPanel'));
    offcanvas.hide();
    e.target.reset();
    loadAll();
  });

  // open edit modal and populate
  async function openEdit(id) {
    const res = await fetch(`${API_BASE}/${id}`);
    if (!res.ok) return alert("Failed to fetch contact");
    const c = await res.json();
    document.getElementById("edit-id").value = c._id;
    document.getElementById("edit-name").value = c.name || "";
    document.getElementById("edit-phone").value = c.phone || "";
    document.getElementById("edit-email").value = c.email || "";
    document.getElementById("edit-address").value = c.address || "";
    document.getElementById("edit-tags").value = (c.tags || []).join(", ");
    editModal.show();
  }

  // submit edit
  document.getElementById("editForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("edit-id").value;
    const payload = {
      name: document.getElementById("edit-name").value.trim(),
      phone: document.getElementById("edit-phone").value.trim(),
      email: document.getElementById("edit-email").value.trim(),
      address: document.getElementById("edit-address").value.trim(),
      tags: document.getElementById("edit-tags").value.split(",").map(t=>t.trim()).filter(Boolean)
    };
    const res = await fetch(`${API_BASE}/${id}`, {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const err = await res.json(); alert(err?.error || "Update failed");
      return;
    }
    editModal.hide();
    loadAll();
  });

  // delete contact
  async function removeContact(id) {
    if (!confirm("Delete this contact?")) return;
    const res = await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
    if (!res.ok) {
      const bad = await res.json(); alert(bad?.error || "Delete failed");
      return;
    }
    loadAll();
  }

  // download csv (server provides file)
  document.getElementById("downloadCsvBtn").addEventListener("click", () => {
    window.location = `${API_BASE}/download_csv`;
  });

  // initial load
  loadAll();
</script>
</body>
</html>